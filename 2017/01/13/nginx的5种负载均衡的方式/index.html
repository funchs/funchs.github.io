<!DOCTYPE html><html lang="zh_CN"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> nginx的5种负载均衡的方式 · 风起时</title><meta name="description" content="nginx的5种负载均衡的方式 - 风起时Funchs"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="short icon" href="/favicon.png"><link rel="stylesheet" href="/css/apollo.css"><link rel="stylesheet" href="http://fonts.useso.com/css?family=Source+Sans+Pro:400,600" type="text/css"></head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/favicon.png"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="/tags/" target="_self" class="nav-list-link">TAG</a></li><li class="nav-list-item"><a href="http://weibo.com/540045660" target="_blank" class="nav-list-link">WEIBO</a></li><li class="nav-list-item"><a href="https://github.com/funchs" target="_blank" class="nav-list-link">GITHUB</a></li><li class="nav-list-item"><a href="/atom.xml" target="_self" class="nav-list-link">RSS</a></li></ul></header><section class="container"><div class="post"><article class="post-block"><h1 class="post-title">nginx的5种负载均衡的方式</h1><div class="post-info">2017年1月13日</div><div class="post-content"><h3 id="nginx的5种负载均衡的方式"><a href="#nginx的5种负载均衡的方式" class="headerlink" title="nginx的5种负载均衡的方式"></a>nginx的5种负载均衡的方式</h3><h4 id="1-roundrobin"><a href="#1-roundrobin" class="headerlink" title="1.roundrobin"></a>1.roundrobin</h4><p>轮询方式(weight=1),依次将请求分配到各个后台服务器中，默认的负载均衡方式。<br>适用于后台机器性能一致的情况。<br>挂掉的机器可以自动从服务列表中剔除。</p>
<p>配置文件如下：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">upstream test &#123;</span><br><span class="line">	server 192.168.109.5:81;</span><br><span class="line">	servse 192.168.109.3:80;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>测试结果：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[root@xxw conf]# for i in $(seq 10); do curl http://192.168.109.4  ;done</span><br><span class="line">192.168.109.5  It is work!</span><br><span class="line">192.168.109.3 It is work!</span><br><span class="line">192.168.109.5  It is work!</span><br><span class="line">192.168.109.3 It is work!</span><br><span class="line">192.168.109.5  It is work!</span><br><span class="line">192.168.109.3 It is work!</span><br><span class="line">192.168.109.5  It is work!</span><br><span class="line">192.168.109.3 It is work!</span><br><span class="line">192.168.109.5  It is work!</span><br><span class="line">192.168.109.3 It is work!</span><br></pre></td></tr></table></figure>
<p>测试结果一直是访问这个1次，再访问那个5次，反复循环。</p>
<h4 id="2-weight"><a href="#2-weight" class="headerlink" title="2.weight"></a>2.weight</h4><p>根据权重来分发请求到不同的机器中，适用于后台机器性能不一样的情况。</p>
<p>如果后端服务器down掉，能自动剔除。<br>比如下面配置，则1.11服务器的访问量为1.10服务器的两倍。</p>
<p>配置文件如下:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">upstream bakend &#123;</span><br><span class="line">	server 192.168.1.10 weight=1;</span><br><span class="line">	server 192.168.1.11 weight=2;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="3-ip-hash"><a href="#3-ip-hash" class="headerlink" title="3.ip_hash"></a>3.ip_hash</h4><p>根据请求者ip的hash值将请求发送到后台服务器中，可以保证来自同一ip的请求被打到固定的机器上，可以解决session问题。<br>如果后端服务器down掉，要手工down掉。</p>
<p>配置文件如下:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">upstream resinserver&#123;</span><br><span class="line">	ip_hash;</span><br><span class="line">	server 192.168.1.10:8080;</span><br><span class="line">	server 192.168.1.11:8080;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>ip_hash是容易理解的，但是因为仅仅能用ip这个因子来分配后端，因此ip_hash是有缺陷的，不能在一些情况下使用：</strong></p>
<ol>
<li>nginx不是最前端的服务器。ip_hash要求nginx一定是最前端的服务器，否则nginx得不到正确ip，就不能根据ip作hash。譬如使用的是squid为最前端，那么nginx取ip时只能得到squid的服务器ip地址，用这个地址来作分流是肯定错乱的。</li>
<li>nginx的后端还有其它方式的负载均衡。假如nginx后端又有其它负载均衡,，将请求又通过另外的方式分流了，那么某个客户端的请求肯定不能定位到同一台session应用服务器上。这么算起来，nginx后端只能直接指向应用服务器，或者再搭一个squid，然后指向应用服务器。最好的办法是用location作一次分流，将需要session的部分请求通过ip_hash分流，剩下的走其它后端去。</li>
</ol>
<h4 id="4-url-hash（第三方插件）"><a href="#4-url-hash（第三方插件）" class="headerlink" title="4.url_hash（第三方插件）"></a>4.url_hash（第三方插件）</h4><p>根据请求的url的hash值将请求分到不同的机器中，当后台服务器为缓存的时候效率高。<br>在upstream中加入hash语句，hash_method是使用的hash算法</p>
<p>配置文件如下:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">upstream resinserver&#123;</span><br><span class="line">	server 192.168.1.10:8080;</span><br><span class="line">	server 192.168.1.11:8080;</span><br><span class="line">	hash $request_uri;</span><br><span class="line">	hash_method crc32;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="5-fair（第三方插件）"><a href="#5-fair（第三方插件）" class="headerlink" title="5.fair（第三方插件）"></a>5.fair（第三方插件）</h4><p>根据后台响应时间来分发请求，响应时间短的分发的请求多。</p>
<p>配置文件如下:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">upstream resinserver&#123;</span><br><span class="line">	server 192.168.1.10:8080;</span><br><span class="line">	server 192.168.1.11:8080;</span><br><span class="line">	fair;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="tips"><a href="#tips" class="headerlink" title="tips:"></a>tips:</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">定义负载均衡设备的Ip及设备状态 </span></span><br><span class="line">upstream bakend&#123; </span><br><span class="line">	ip_hash;  </span><br><span class="line">	server 127.0.0.1:9090 down;  </span><br><span class="line">	server 127.0.0.1:8080 weight=2;  </span><br><span class="line">	server 127.0.0.1:6060;  </span><br><span class="line">	server 127.0.0.1:7070 backup;  </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">在需要使用负载均衡的server中增加  </span></span><br><span class="line">proxy_pass http://bakend/;</span><br></pre></td></tr></table></figure>
<h4 id="设备的状态"><a href="#设备的状态" class="headerlink" title="设备的状态"></a>设备的状态</h4><ol>
<li>down 表示单前的server暂时不参与负载 </li>
<li>weight 权重,默认为1。 weight越大，负载的权重就越大。 </li>
<li>max_fails 允许请求失败的次数默认为1。当超过最大次数时，返回proxy_next_upstream 模块定义的错误 </li>
<li>fail_timeout max_fails次失败后，暂停的时间。 </li>
<li>backup 备用服务器, 其它所有的非backup机器down或者忙的时候，请求backup机器。所以这台机器压力会最轻。</li>
</ol>
<h4 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h4><p>nginx支持同时设置多组的负载均衡，用来给不用的server来使用。<br>client_body_in_file_only 设置为On 可以讲client post过来的数据记录到文件中用来做debug<br>client_body_temp_path 设置记录文件的目录 可以设置最多3层目录  </p>
<p>location 对URL进行匹配.可以进行重定向或者进行新的代理 负载均衡</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">location / &#123;</span><br><span class="line">	proxy_pass	http://test /;   #将请求传到负载服务器池</span><br><span class="line">&#125;</span><br><span class="line">root 指令：指定目录</span><br><span class="line">proxy_pass  proxy_store  proxy_cache ：实现缓存代理</span><br><span class="line">expires  指定缓存时间</span><br></pre></td></tr></table></figure></div></article></div></section><footer><div class="paginator"><a href="/2018/04/10/Ubuntu 16.04安装Java JDK相关/" class="prev">PREV</a><a href="/2016/11/04/centos tar压缩与解压缩命令大全/" class="next">NEXT</a></div><div id="disqus_thread"></div><script>var disqus_shortname = 'seansun';
var disqus_identifier = '2017/01/13/nginx的5种负载均衡的方式/';
var disqus_title = 'nginx的5种负载均衡的方式';
var disqus_url = 'http://funchs.com/2017/01/13/nginx的5种负载均衡的方式/';
(function() {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();</script><script id="dsq-count-scr" src="//seansun.disqus.com/count.js" async></script><div class="copyright"><p>© 2016 - 2018 <a href="http://funchs.com">风起时Funchs</a>, unless otherwise noted.</p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.6.1/MathJax.js?config=TeX-MML-AM_CHTML"></script><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;e=o.createElement(i);r=o.getElementsByTagName(i)[0];e.src='//www.google-analytics.com/analytics.js';r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));ga('create',"UA-65933410-1",'auto');ga('send','pageview');</script></body></html>